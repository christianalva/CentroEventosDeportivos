@page "/eventos/listar"
@rendermode InteractiveServer
@inject ListarEventosUseCase listarEvento
@inject EventoDeportivoBajaUseCase eliminarEvento
@inject ModificarEventosUseCase modificarEvento
@inject NavigationManager navManager
@inject IServicioSesion servicioSesion

<DialogoConfirmacion @ref="dialogo" OnConfirmado="Eliminar"/>

@if (_mensajeError.Any())
{
    <ul class="alerta-error">
        @foreach (var error in _mensajeError)
        {
            <li>@error</li>
        }
    </ul>
}

@if(usuarioEnSesion != null){
    <div class="contenedor-listado">
        <h1 class="titulo-listado">Listado de Eventos Deportivos</h1>
        <div class="pagina-contenedor">
            <div class="contenedor-tabla">
                <table class="tabla-usuarios">
                    <thead class="table-dark">
                        <tr>
                            <th class="encabezado-tabla">ID</th>
                            <th class="encabezado-tabla">NOMBRE</th>
                            <th class="encabezado-tabla">DESCRIPCION</th>
                            <th class="encabezado-tabla">FECHA Y HORA</th>
                            <th class="encabezado-tabla">DURACION (Hs)</th>
                            <th class="encabezado-tabla">CUPO MAXIMO</th>
                            <th class="encabezado-tabla">ID RESPONSABLE</th>
                            <th class="encabezado-tabla">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var eve in _lista)
                        {
                            <tr>
                               <td>@eve.Id</td>
                               <td>@eve.Nombre</td>
                               <td>@eve.Descripcion</td>
                               <td>@eve.FechaHoraInicio</td>
                               <td>@eve.DuracionHoras</td>
                               <td>@eve.CupoMaximo</td>
                               <td>@eve.ResponsableId</td>
                               <td>
                                    <div class="acciones-contenedor">
                                        <button class="boton-editar" @onclick="()=>EditarEvento(eve)">Editar</button>
                                        <button class="boton-eliminar"  @onclick="()=>ConfirmarEliminacion(eve)">Eliminar</button>
                                    </div>
                               </td>
                           </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}


@code {
    List<EventoDeportivo> _lista = new List<EventoDeportivo>();
    List<string> _mensajeError = new();
    private Usuario? usuarioEnSesion;

    protected override void OnInitialized()
    {
        usuarioEnSesion = servicioSesion.UsuarioActual;

        if(usuarioEnSesion == null){
            _mensajeError.Add("Debe Iniciar sesion.");
            return;
        }
        // Llamo al caso de uso para listar en pantalla a los usuarios, siempre que posea los permisos
        _lista = listarEvento.Ejecutar();
    }

    DialogoConfirmacion dialogo = null!;
    EventoDeportivo? _eventoAEliminar = null;

    private void ConfirmarEliminacion(EventoDeportivo eve)
    {      
        if(!usuarioEnSesion!.Permisos.Contains(CentroEventos.Aplicacion.Enums.Permiso.EventoBaja)){
            _mensajeError.Add("No cuenta con el permiso para Eliminar el Evento Deportivo.");
            return;
        }
        
        _eventoAEliminar = eve;
        dialogo.SetMensaje($"Â¿Desea eliminar al Evento Deportivo {eve.Nombre}?");  
        dialogo.Mostrar();
    }
        
    

    private void Eliminar()
    {
        if (_eventoAEliminar != null)
        {
            try
            {
                eliminarEvento.Ejecutar(_eventoAEliminar.Id);
                _lista = listarEvento.Ejecutar();
            }
            catch (CentroEventos.Aplicacion.Excepciones.FalloAutorizacionException ex)
            {
                _mensajeError.Add(ex.Message);
            }
            catch (CentroEventos.Aplicacion.Excepciones.EntidadNotFoundException ex)
            {
                _mensajeError.Add(ex.Message);
            }
            catch (CentroEventos.Aplicacion.Excepciones.OperacionInvalidaException ex)
            {
                _mensajeError.Add(ex.Message);
            }
        }
    }


    private void EditarEvento(EventoDeportivo eve)
    {
        _mensajeError.Clear();
        if(servicioSesion.UsuarioActual != null){
            // Verifico si el usuario actual tiene el permiso para modificar
            if (!servicioSesion.UsuarioActual.Permisos.Contains(CentroEventos.Aplicacion.Enums.Permiso.EventoModificacion))
            {
                _mensajeError.Add("No cuenta con el permiso para modificar el Evento Deportivo.");
                return;
            }

            // Si tiene permiso lo redirijo a la pagina de modificacion 
            navManager.NavigateTo($"/eventos/modificar/{eve.Id}");
            }
    }

}